# é‡åŒ–å›æµ‹æ¡†æ¶ - æ•°æ®æ¨¡å—

è¿™æ˜¯ä¸€ä¸ªç”¨äºé‡åŒ–äº¤æ˜“å›æµ‹çš„æ•°æ®è·å–å’Œå¤„ç†æ¡†æ¶ã€‚è¯¥æ¡†æ¶è®¾è®¡ç”¨äºä»Tushareè·å–è‚¡ç¥¨æ•°æ®ï¼Œè¿›è¡Œæ¸…æ´—ã€å¯¹é½å’Œæ ‡å‡†åŒ–å¤„ç†ï¼Œæœ€åå­˜å‚¨ä¸ºé«˜æ•ˆçš„Parquetæ ¼å¼ã€‚

## é¡¹ç›®ç»“æ„

```
quant_proj/
â”œâ”€ config/
â”‚   â””â”€ universe.csv          # è‚¡ç¥¨æ±  ts_code åˆ—ï¼Œä¸€è¡Œä¸€ä¸ª
â”œâ”€ data/
â”‚   â”œâ”€ raw/                  # åŸå§‹æ‹‰å–ï¼ˆå¯åˆ é™¤ï¼‰
â”‚   â””â”€ processed/YYYY/MM/    # æ¸…æ´—å Parquet åˆ†åŒº
â”œâ”€ engine/
â”‚   â”œâ”€ data_fetcher.py       # â¬‡ï¸ æ‹‰å–
â”‚   â”œâ”€ aligner.py            # ğŸ”„ å¯¹é½ / å»å‰è§†
â”‚   â”œâ”€ cleaner.py            # ğŸ§¹ ç¼ºå¤± + æå€¼
â”‚   â””â”€ storage.py            # ğŸ’¾ Parquet I/O
â””â”€ scripts/
    â”œâ”€ build_data_warehouse.py
    â””â”€ update_universe.py     # è‡ªåŠ¨æ›´æ–°è‚¡ç¥¨æ± 
```

## å®‰è£…å’Œä½¿ç”¨

### 1. å®‰è£…ä¾èµ–

```bash
pip install tushare pandas pyarrow python-dotenv tqdm rich
```

### 2. é…ç½®

åˆ›å»ºä¸€ä¸ª`.env`æ–‡ä»¶ï¼ˆå¯ä»`.env.template`å¤åˆ¶ï¼‰ï¼Œå¡«å…¥ä½ çš„Tushare API Tokenï¼š

```
TUSHARE_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 3. æ›´æ–°è‚¡ç¥¨æ± 

æ‚¨å¯ä»¥ä½¿ç”¨`update_universe.py`è„šæœ¬ä»Tushareè‡ªåŠ¨è·å–å¹¶æ›´æ–°è‚¡ç¥¨æ± ï¼š

```bash
# é»˜è®¤ä½¿ç”¨æ²ªæ·±300æˆåˆ†è‚¡ï¼Œå¸‚å€¼100äº¿ä»¥ä¸Š
python scripts/update_universe.py

# ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å‚æ•°
# ä¸­è¯500æˆåˆ†è‚¡
python scripts/update_universe.py --index_code 000905.SH

# ç§‘åˆ›æ¿è‚¡ç¥¨
python scripts/update_universe.py --market ç§‘åˆ›æ¿ --index_code None

# å¸‚å€¼1000äº¿ä»¥ä¸Šçš„è‚¡ç¥¨
python scripts/update_universe.py --index_code None --min_market_cap 1000
```

### 4. è¿è¡Œæ•°æ®è·å–è„šæœ¬

```bash
python scripts/build_data_warehouse.py
```

## æ•°æ®æµç¨‹

1. **è·å–æ•°æ®**ï¼šä»Tushare APIè·å–æ—¥çº¿å’Œè´¢åŠ¡æ•°æ®
2. **æ¸…æ´—æ•°æ®**ï¼šå»é™¤åœç‰Œæ—¥ï¼Œå¤„ç†ç¼ºå¤±å€¼
3. **å¯¹é½æ•°æ®**ï¼šå°†è´¢åŠ¡æ•°æ®å¯¹é½åˆ°æ—¥çº¿ï¼Œç¡®ä¿æ— å‰è§†åå·®
4. **æ ‡å‡†åŒ–**ï¼šå¯¹å› å­è¿›è¡Œå»æå€¼å’Œæ ‡å‡†åŒ–å¤„ç†
5. **å­˜å‚¨**ï¼šæŒ‰å¹´æœˆåˆ†åŒºå­˜å‚¨ä¸ºParquetæ ¼å¼ï¼Œå¸¦æŒ‡çº¹æ£€æµ‹é¿å…é‡å¤å†™å…¥

## éªŒè¯æ¸…å•

| æ£€æŸ¥é¡¹ | å¿«é€Ÿæ–¹æ³• |
|-------|---------|
| å‰è§†è¡Œæ•° = 0 | `df[df.index < df['pub_date']].shape[0]` |
| ç¼ºå¤±ç‡ < 1% | `joined.isna().mean().mean()` |
| Parquet è¯»å–é€Ÿåº¦ | `pd.read_parquet("data/processed/2025/07/*.parquet", columns=["close"])` < 2s |
| é‡è·‘å“ˆå¸Œä¸å˜ | è¿ç»­æ‰§è¡Œè„šæœ¬åº”åªè¾“å‡º "âœ… æ•°æ®ä»“åˆ·æ–°å®Œæˆ" æ— æ–°å¢å†™å…¥æ—¥å¿— |

## åŠ é€ŸæŠ€å·§

- å¤šçº¿ç¨‹å¹¶å‘ï¼šä½¿ç”¨`concurrent.futures.ThreadPoolExecutor`åŠ é€Ÿæ•°æ®è·å–
- äº¤æ˜“æ—¥ç´¢å¼•ç¼“å­˜ï¼šå…¨å±€å¤ç”¨äº¤æ˜“æ—¥å†ä»¥æé«˜å¯¹é½æ•ˆç‡
- å¢é‡æ›´æ–°ï¼šåªè·å–æœ€æ–°æ•°æ®ï¼Œä¸æœ¬åœ°æ•°æ®æ‹¼æ¥ä»¥åŠ å¿«æ›´æ–°é€Ÿåº¦
